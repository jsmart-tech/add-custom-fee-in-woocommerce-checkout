// Add custom fields to the WooCommerce order review section.
add_action('woocommerce_pay_order_before_submit', 'custom_add_custom_fields_to_order_review');
function custom_add_custom_fields_to_order_review() {
    woocommerce_form_field('custom_government_id_upload', array(
        'type' => 'file',
        'class' => array('form-row-wide'),
        'label' => '<strong>' . __('Kindly Upload a Valid Government ID') . '</strong>',
        'required' => true,
        'placeholder' => __('Choose a file'),
    ));
}

// Save custom field data when order status changes to "processing"
add_action('woocommerce_order_status_processing', 'custom_save_custom_field_data');
function custom_save_custom_field_data($order_id) {
    if (isset($_FILES['custom_government_id_upload'])) {
        $uploaded_file = $_FILES['custom_government_id_upload'];
        $upload_overrides = array('test_form' => false);

        $movefile = wp_handle_upload($uploaded_file, $upload_overrides);

        if ($movefile && !isset($movefile['error'])) {
            $file_url = $movefile['url'];
            update_post_meta($order_id, '_custom_government_id_upload', $file_url);
        }
    }
}

// Display the custom field in the thank you page
add_action('woocommerce_thankyou', 'custom_display_custom_field_on_thankyou_page');
function custom_display_custom_field_on_thankyou_page($order_id) {
    $order = wc_get_order($order_id);
    $file_url = $order->get_meta('_custom_government_id_upload');

    if (!empty($file_url)) {
        echo '<p><strong>' . __('Kindly Upload a Valid Government ID') . ':</strong> <a href="' . esc_url($file_url) . '">Download File</a></p>';
    }
}

// Display custom field value on the admin order edit page
add_action('woocommerce_admin_order_data_after_billing_address', 'custom_display_custom_field_on_admin_order_page');
function custom_display_custom_field_on_admin_order_page($order) {
    $file_url = get_post_meta($order->get_id(), '_custom_government_id_upload', true);

    if (!empty($file_url)) {
        echo '<p><strong>Kindly Upload a Valid Government ID:</strong> <a href="' . esc_url($file_url) . '">Download File</a></p>';
    }
}
